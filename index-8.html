<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROTEIN BAR INDEX</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #f5f3ee;
    --surface: #ffffff;
    --border: #e0ddd6;
    --border-strong: #c8c4bc;
    --text: #1a1916;
    --text-muted: #7a7670;
    --text-faint: #b0ada8;
    --accent: #d4f564;
    --accent-dark: #9ab83a;
    --rank1: #f5c842;
    --rank2: #d4d4d4;
    --rank3: #c9906a;
    --red: #e85d4a;
    --green: #4a9e6b;
    --mono: 'DM Mono', monospace;
    --sans: 'Syne', sans-serif;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    min-height: 100vh;
  }

  /* HEADER */
  .site-header {
    border-bottom: 1.5px solid var(--border-strong);
    padding: 28px 40px 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    background: var(--bg);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: var(--sans);
    font-weight: 800;
    font-size: 22px;
    letter-spacing: -0.5px;
    line-height: 1;
  }
  .logo span {
    background: var(--accent);
    padding: 2px 7px;
    margin-right: 4px;
  }
  .logo-sub {
    font-family: var(--mono);
    font-weight: 300;
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 5px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .header-meta {
    text-align: right;
    color: var(--text-muted);
    font-size: 11px;
    letter-spacing: 0.05em;
  }
  .header-meta strong { color: var(--text); font-weight: 500; }

  /* FILTERS */
  .filters-bar {
    padding: 16px 40px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
    background: var(--bg);
  }

  .filter-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-right: 4px;
  }

  .filter-group {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-wrap: wrap;
  }

  .filter-btn {
    padding: 5px 12px;
    border: 1px solid var(--border-strong);
    background: var(--surface);
    font-family: var(--mono);
    font-size: 11px;
    cursor: pointer;
    color: var(--text-muted);
    transition: all 0.12s;
    letter-spacing: 0.03em;
  }
  .filter-btn:hover { border-color: var(--text); color: var(--text); }
  .filter-btn.active { background: var(--text); color: var(--bg); border-color: var(--text); }

  .filter-divider {
    width: 1px;
    height: 20px;
    background: var(--border-strong);
    margin: 0 4px;
  }

  .search-box {
    padding: 5px 12px;
    border: 1px solid var(--border-strong);
    background: var(--surface);
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text);
    outline: none;
    width: 180px;
    transition: border-color 0.12s;
  }
  .search-box:focus { border-color: var(--text); }
  .search-box::placeholder { color: var(--text-faint); }

  /* TABLE WRAPPER */
  .table-wrapper {
    padding: 0 40px 60px;
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0;
  }

  /* THEAD */
  thead tr {
    border-bottom: 1.5px solid var(--border-strong);
  }

  th {
    padding: 12px 10px;
    text-align: left;
    font-family: var(--mono);
    font-weight: 500;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    transition: color 0.12s;
    position: relative;
  }
  th:hover { color: var(--text); }
  th.sorted { color: var(--text); }
  th.sorted::after {
    content: attr(data-dir);
    margin-left: 5px;
    font-size: 10px;
  }
  th:first-child { width: 44px; text-align: center; }
  th:nth-child(2) { min-width: 160px; }

  /* TBODY */
  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
    cursor: default;
  }
  tbody tr:hover { background: rgba(0,0,0,0.025); }
  tbody tr.hidden { display: none; }

  td {
    padding: 13px 10px;
    vertical-align: middle;
    white-space: nowrap;
  }

  /* RANK */
  .rank {
    text-align: center;
    font-family: var(--sans);
    font-weight: 700;
    font-size: 13px;
  }
  .rank-1 { color: var(--rank1); }
  .rank-2 { color: var(--rank2); filter: brightness(0.65); }
  .rank-3 { color: var(--rank3); }

  /* BAR NAME */
  .bar-name {
    font-family: var(--sans);
    font-weight: 600;
    font-size: 13px;
    letter-spacing: -0.2px;
  }
  .bar-brand {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 2px;
    letter-spacing: 0.04em;
  }
  .bar-tags {
    display: flex;
    gap: 4px;
    margin-top: 4px;
    flex-wrap: wrap;
  }
  .tag {
    font-size: 9px;
    padding: 1px 6px;
    border: 1px solid var(--border);
    color: var(--text-muted);
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .tag.vegan { border-color: #4a9e6b; color: #4a9e6b; }
  .tag.keto { border-color: #9b6fd4; color: #9b6fd4; }
  .tag.gf { border-color: #e8934a; color: #e8934a; }

  /* MACROS */
  .macro-val {
    font-weight: 500;
  }
  .macro-unit {
    font-size: 10px;
    color: var(--text-muted);
    margin-left: 1px;
  }
  .protein-val { color: #2a6fad; }
  .carb-val { color: #c17c2a; }
  .fat-val { color: #9b6fd4; }

  /* SCORE BARS */
  .score-cell {
    min-width: 90px;
  }
  .score-num {
    font-weight: 500;
    font-size: 12px;
    margin-bottom: 3px;
  }
  .score-bar-track {
    width: 70px;
    height: 3px;
    background: var(--border);
    position: relative;
  }
  .score-bar-fill {
    height: 100%;
    background: var(--text);
    transition: width 0.3s ease;
  }
  .score-bar-fill.excellent { background: var(--green); }
  .score-bar-fill.good { background: #a3c94a; }
  .score-bar-fill.avg { background: #e8b84a; }
  .score-bar-fill.poor { background: var(--red); }

  /* COMPOSITE SCORE */
  .composite {
    font-family: var(--sans);
    font-weight: 700;
    font-size: 15px;
    letter-spacing: -0.5px;
  }
  .composite.s { color: var(--green); }
  .composite.a { color: #7ab82a; }
  .composite.b { color: #c4a020; }
  .composite.c { color: #e07a30; }
  .composite.d { color: var(--red); }

  /* PRICE */
  .price-val {
    font-weight: 500;
  }
  .ppd {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 2px;
  }
  .ppd.great { color: var(--green); }
  .ppd.ok { color: #c4a020; }
  .ppd.poor { color: var(--red); }

  /* FLAVOR BADGE */
  .flavor-pill {
    font-size: 10px;
    padding: 2px 8px;
    background: var(--border);
    color: var(--text-muted);
    letter-spacing: 0.03em;
  }

  /* SORT INDICATOR */
  .sort-arrow { margin-left: 4px; opacity: 0.4; }
  th.sorted .sort-arrow { opacity: 1; }

  /* FOOTER */
  .site-footer {
    border-top: 1px solid var(--border);
    padding: 20px 40px;
    font-size: 11px;
    color: var(--text-faint);
    display: flex;
    justify-content: space-between;
  }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
    font-size: 12px;
    display: none;
  }
  .empty-state.visible { display: block; }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .site-header, .filters-bar, .table-wrapper { padding-left: 16px; padding-right: 16px; }
    .logo { font-size: 18px; }
  }
</style>
</head>
<body>

<header class="site-header">
  <div>
    <div class="logo"><span>PBI</span> PROTEIN BAR INDEX</div>
    <div class="logo-sub">Leaderboard &amp; Macro Intelligence â€” <span id="bar-count">25</span> bars ranked</div>
  </div>
  <div class="header-meta">
    Sorted by <strong id="sort-label">Overall Score</strong><br>
    Click any column to re-rank
  </div>
</header>

<div class="filters-bar">
  <span class="filter-label">Brand</span>
  <div class="filter-group" id="brand-filters">
    <button class="filter-btn active" data-filter="brand" data-value="all">All</button>
    <button class="filter-btn" data-filter="brand" data-value="Quest">Quest</button>
    <button class="filter-btn" data-filter="brand" data-value="RXBar">RXBar</button>
    <button class="filter-btn" data-filter="brand" data-value="Kind">Kind</button>
    <button class="filter-btn" data-filter="brand" data-value="Clif">Clif</button>
    <button class="filter-btn" data-filter="brand" data-value="Barebells">Barebells</button>
    <button class="filter-btn" data-filter="brand" data-value="ONE">ONE</button>
    <button class="filter-btn" data-filter="brand" data-value="Built">Built</button>
    <button class="filter-btn" data-filter="brand" data-value="Grenade">Grenade</button>
  </div>

  <div class="filter-divider"></div>

  <span class="filter-label">Flavour</span>
  <div class="filter-group" id="flavor-filters">
    <button class="filter-btn active" data-filter="flavor" data-value="all">All</button>
    <button class="filter-btn" data-filter="flavor" data-value="Chocolate">Choc</button>
    <button class="filter-btn" data-filter="flavor" data-value="Nut">Nut</button>
    <button class="filter-btn" data-filter="flavor" data-value="Fruit">Fruit</button>
    <button class="filter-btn" data-filter="flavor" data-value="Vanilla">Vanilla</button>
    <button class="filter-btn" data-filter="flavor" data-value="Peanut Butter">PB</button>
  </div>

  <div class="filter-divider"></div>

  <span class="filter-label">Diet</span>
  <div class="filter-group" id="diet-filters">
    <button class="filter-btn active" data-filter="diet" data-value="all">All</button>
    <button class="filter-btn" data-filter="diet" data-value="vegan">Vegan</button>
    <button class="filter-btn" data-filter="diet" data-value="keto">Keto</button>
    <button class="filter-btn" data-filter="diet" data-value="gf">Gluten-Free</button>
  </div>

  <div class="filter-divider"></div>

  <input class="search-box" type="text" id="search-input" placeholder="Search bars...">
</div>

<div class="table-wrapper">
  <table id="main-table">
    <thead>
      <tr>
        <th data-col="rank" class="sorted" data-dir="â†‘">#<span class="sort-arrow">â†‘</span></th>
        <th data-col="name">Bar <span class="sort-arrow">â†•</span></th>
        <th data-col="calories">Cals<span class="sort-arrow">â†•</span></th>
        <th data-col="protein">Protein<span class="sort-arrow">â†•</span></th>
        <th data-col="carbs">Carbs<span class="sort-arrow">â†•</span></th>
        <th data-col="fat">Fat<span class="sort-arrow">â†•</span></th>
        <th data-col="sugar">Sugar<span class="sort-arrow">â†•</span></th>
        <th data-col="rating">Rating<span class="sort-arrow">â†•</span></th>
        <th data-col="flavor_score">Flavour<span class="sort-arrow">â†•</span></th>
        <th data-col="ingredients">Ingredients<span class="sort-arrow">â†•</span></th>
        <th data-col="price">Price / PPD<span class="sort-arrow">â†•</span></th>
        <th data-col="score">Score<span class="sort-arrow">â†•</span></th>
      </tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>
  <div class="empty-state" id="empty-state">No bars match your filters.</div>
</div>

<footer class="site-footer">
  <span>Protein Bar Index Â· Data updated 2025</span>
  <span>All values per bar serving. PPD = protein per dollar.</span>
</footer>

<script>
const BARS = [
  { name:"Double Chocolate Chunk", brand:"Quest", flavor_cat:"Chocolate", tags:["keto","gf"], calories:190, protein:21, carbs:22, fat:7, sugar:1, rating:9.1, flavor_score:9.2, ingredients:8.5, price:2.49, ppd:8.4 },
  { name:"Cookies & Cream", brand:"Quest", flavor_cat:"Vanilla", tags:["keto","gf"], calories:190, protein:21, carbs:21, fat:8, sugar:1, rating:9.3, flavor_score:9.5, ingredients:8.5, price:2.49, ppd:8.4 },
  { name:"Chocolate Sea Salt", brand:"Barebells", flavor_cat:"Chocolate", tags:[], calories:200, protein:20, carbs:20, fat:7, sugar:2, rating:9.5, flavor_score:9.7, ingredients:7.8, price:2.99, ppd:6.7 },
  { name:"Caramel Cashew", brand:"Barebells", flavor_cat:"Nut", tags:[], calories:200, protein:20, carbs:21, fat:7, sugar:2, rating:9.2, flavor_score:9.4, ingredients:7.8, price:2.99, ppd:6.7 },
  { name:"Chocolate Chip Cookie Dough", brand:"Quest", flavor_cat:"Chocolate", tags:["keto","gf"], calories:190, protein:21, carbs:25, fat:8, sugar:1, rating:8.9, flavor_score:9.1, ingredients:8.5, price:2.49, ppd:8.4 },
  { name:"Birthday Cake", brand:"Quest", flavor_cat:"Vanilla", tags:["keto","gf"], calories:190, protein:21, carbs:22, fat:7, sugar:1, rating:8.7, flavor_score:8.8, ingredients:8.3, price:2.49, ppd:8.4 },
  { name:"Chocolate PB", brand:"RXBar", flavor_cat:"Peanut Butter", tags:["gf"], calories:210, protein:12, carbs:24, fat:9, sugar:13, rating:8.4, flavor_score:8.9, ingredients:9.8, price:2.79, ppd:4.3 },
  { name:"Blueberry", brand:"RXBar", flavor_cat:"Fruit", tags:["gf"], calories:210, protein:12, carbs:25, fat:8, sugar:15, rating:7.8, flavor_score:7.9, ingredients:9.7, price:2.79, ppd:4.3 },
  { name:"Coconut Chocolate", brand:"RXBar", flavor_cat:"Chocolate", tags:["gf"], calories:210, protein:12, carbs:23, fat:9, sugar:14, rating:8.1, flavor_score:8.3, ingredients:9.6, price:2.79, ppd:4.3 },
  { name:"Chocolate Almond Sea Salt", brand:"Kind", flavor_cat:"Nut", tags:["gf"], calories:180, protein:6, carbs:20, fat:10, sugar:5, rating:7.9, flavor_score:8.5, ingredients:9.2, price:1.99, ppd:3.0 },
  { name:"Caramel Almond & Sea Salt", brand:"Kind", flavor_cat:"Nut", tags:["gf"], calories:200, protein:6, carbs:25, fat:9, sugar:8, rating:7.6, flavor_score:8.2, ingredients:9.0, price:1.99, ppd:3.0 },
  { name:"Dark Chocolate Nuts & Sea Salt", brand:"Kind", flavor_cat:"Chocolate", tags:["gf","vegan"], calories:180, protein:6, carbs:18, fat:11, sugar:5, rating:8.0, flavor_score:8.6, ingredients:9.1, price:1.99, ppd:3.0 },
  { name:"Whey Protein Bar Peanut Butter", brand:"ONE", flavor_cat:"Peanut Butter", tags:["gf"], calories:220, protein:20, carbs:24, fat:8, sugar:1, rating:8.3, flavor_score:8.4, ingredients:7.2, price:2.39, ppd:8.4 },
  { name:"Birthday Cake", brand:"ONE", flavor_cat:"Vanilla", tags:["gf"], calories:220, protein:20, carbs:26, fat:7, sugar:1, rating:8.0, flavor_score:8.1, ingredients:7.2, price:2.39, ppd:8.4 },
  { name:"Chocolate Brownie", brand:"ONE", flavor_cat:"Chocolate", tags:["gf"], calories:210, protein:20, carbs:23, fat:7, sugar:1, rating:8.1, flavor_score:8.2, ingredients:7.3, price:2.39, ppd:8.4 },
  { name:"Chocolate Chip", brand:"Clif", flavor_cat:"Chocolate", tags:["vegan"], calories:240, protein:10, carbs:43, fat:5, sugar:21, rating:7.5, flavor_score:8.0, ingredients:7.9, price:1.79, ppd:5.6 },
  { name:"Peanut Butter Banana", brand:"Clif", flavor_cat:"Peanut Butter", tags:["vegan"], calories:250, protein:10, carbs:43, fat:7, sugar:20, rating:7.4, flavor_score:8.1, ingredients:7.8, price:1.79, ppd:5.6 },
  { name:"Blueberry Crisp", brand:"Clif", flavor_cat:"Fruit", tags:["vegan"], calories:240, protein:9, carbs:45, fat:4, sugar:22, rating:7.1, flavor_score:7.6, ingredients:7.8, price:1.79, ppd:5.0 },
  { name:"Chocolate Chip Cookie Dough", brand:"Built", flavor_cat:"Chocolate", tags:[], calories:150, protein:17, carbs:17, fat:4, sugar:2, rating:8.6, flavor_score:8.7, ingredients:7.5, price:2.19, ppd:7.8 },
  { name:"Peanut Butter & Jelly", brand:"Built", flavor_cat:"Peanut Butter", tags:[], calories:150, protein:17, carbs:17, fat:4, sugar:2, rating:8.3, flavor_score:8.5, ingredients:7.4, price:2.19, ppd:7.8 },
  { name:"Carrot Cake", brand:"Built", flavor_cat:"Vanilla", tags:[], calories:150, protein:17, carbs:16, fat:4, sugar:2, rating:8.1, flavor_score:8.2, ingredients:7.5, price:2.19, ppd:7.8 },
  { name:"Dark Chocolate Mint", brand:"Grenade", flavor_cat:"Chocolate", tags:[], calories:216, protein:23, carbs:20, fat:8, sugar:2, rating:8.9, flavor_score:9.0, ingredients:7.6, price:3.29, ppd:7.0 },
  { name:"Fudge Brownie", brand:"Grenade", flavor_cat:"Chocolate", tags:[], calories:228, protein:22, carbs:22, fat:9, sugar:2, rating:8.7, flavor_score:8.9, ingredients:7.5, price:3.29, ppd:6.7 },
  { name:"Banana Armour", brand:"Grenade", flavor_cat:"Fruit", tags:[], calories:212, protein:22, carbs:19, fat:8, sugar:2, rating:8.4, flavor_score:8.6, ingredients:7.4, price:3.29, ppd:6.7 },
  { name:"Peanut Nutter", brand:"Grenade", flavor_cat:"Peanut Butter", tags:[], calories:222, protein:22, carbs:21, fat:9, sugar:2, rating:8.6, flavor_score:8.8, ingredients:7.5, price:3.29, ppd:6.7 },
];

function computeScore(b) {
  // Weighted composite: protein density, sugar penalty, rating, flavor, ingredients, value
  const proteinDensity = (b.protein / b.calories) * 100; // higher = better
  const sugarPenalty = Math.max(0, 10 - b.sugar * 0.4);
  const valueScore = Math.min(10, b.ppd / 1.2);
  return (
    proteinDensity * 0.8 +
    sugarPenalty * 0.5 +
    b.rating * 0.9 +
    b.flavor_score * 0.6 +
    b.ingredients * 0.7 +
    valueScore * 0.5
  ) / 4.0;
}

function gradeScore(s) {
  if (s >= 9.0) return 'S';
  if (s >= 8.0) return 'A';
  if (s >= 7.0) return 'B';
  if (s >= 6.0) return 'C';
  return 'D';
}

function scoreClass(s) {
  if (s >= 9.0) return 's';
  if (s >= 8.0) return 'a';
  if (s >= 7.0) return 'b';
  if (s >= 6.0) return 'c';
  return 'd';
}

function barFillClass(v, max) {
  const pct = v / max;
  if (pct >= 0.85) return 'excellent';
  if (pct >= 0.65) return 'good';
  if (pct >= 0.45) return 'avg';
  return 'poor';
}

// Enrich data
const data = BARS.map(b => ({ ...b, score: computeScore(b) }));

let sortCol = 'score';
let sortDir = -1; // -1 = desc
let activeFilters = { brand: 'all', flavor: 'all', diet: 'all' };
let searchQuery = '';

function sortData(arr) {
  return [...arr].sort((a, b) => {
    let av = a[sortCol], bv = b[sortCol];
    if (typeof av === 'string') return sortDir * av.localeCompare(bv);
    return sortDir * (bv - av);
  });
}

function filterData(arr) {
  return arr.filter(b => {
    if (activeFilters.brand !== 'all' && b.brand !== activeFilters.brand) return false;
    if (activeFilters.flavor !== 'all' && b.flavor_cat !== activeFilters.flavor) return false;
    if (activeFilters.diet !== 'all' && !b.tags.includes(activeFilters.diet)) return false;
    if (searchQuery && !`${b.name} ${b.brand}`.toLowerCase().includes(searchQuery.toLowerCase())) return false;
    return true;
  });
}

function renderTable() {
  const sorted = sortData(data);
  const filtered = filterData(sorted);
  const tbody = document.getElementById('table-body');
  const empty = document.getElementById('empty-state');
  document.getElementById('bar-count').textContent = data.length;

  if (filtered.length === 0) {
    tbody.innerHTML = '';
    empty.classList.add('visible');
    return;
  }
  empty.classList.remove('visible');

  tbody.innerHTML = filtered.map((b, i) => {
    const rank = i + 1;
    const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : '';
    const tagHTML = b.tags.map(t => `<span class="tag ${t}">${t === 'gf' ? 'GF' : t}</span>`).join('');
    const scoreVal = b.score.toFixed(1);
    const grade = gradeScore(b.score);
    const sc = scoreClass(b.score);

    const rFill = barFillClass(b.rating, 10);
    const fFill = barFillClass(b.flavor_score, 10);
    const iFill = barFillClass(b.ingredients, 10);

    const ppdClass = b.ppd >= 7 ? 'great' : b.ppd >= 5 ? 'ok' : 'poor';

    return `<tr>
      <td class="rank ${rankClass}">${rank <= 3 ? ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'][rank-1] : rank}</td>
      <td>
        <div class="bar-name">${b.name}</div>
        <div class="bar-brand">${b.brand} Â· <span style="color:var(--text-faint)">${b.flavor_cat}</span></div>
        ${b.tags.length ? `<div class="bar-tags">${tagHTML}</div>` : ''}
      </td>
      <td><span class="macro-val">${b.calories}</span><span class="macro-unit">kcal</span></td>
      <td><span class="macro-val protein-val">${b.protein}</span><span class="macro-unit">g</span></td>
      <td><span class="macro-val carb-val">${b.carbs}</span><span class="macro-unit">g</span></td>
      <td><span class="macro-val fat-val">${b.fat}</span><span class="macro-unit">g</span></td>
      <td><span class="macro-val" style="color:${b.sugar<=3?'var(--green)':b.sugar<=8?'var(--text)':'var(--red)'}">${b.sugar}</span><span class="macro-unit">g</span></td>
      <td class="score-cell">
        <div class="score-num">${b.rating.toFixed(1)}</div>
        <div class="score-bar-track"><div class="score-bar-fill ${rFill}" style="width:${b.rating*10}%"></div></div>
      </td>
      <td class="score-cell">
        <div class="score-num">${b.flavor_score.toFixed(1)}</div>
        <div class="score-bar-track"><div class="score-bar-fill ${fFill}" style="width:${b.flavor_score*10}%"></div></div>
      </td>
      <td class="score-cell">
        <div class="score-num">${b.ingredients.toFixed(1)}</div>
        <div class="score-bar-track"><div class="score-bar-fill ${iFill}" style="width:${b.ingredients*10}%"></div></div>
      </td>
      <td>
        <div class="price-val">$${b.price.toFixed(2)}</div>
        <div class="ppd ${ppdClass}">${b.ppd.toFixed(1)}g/$</div>
      </td>
      <td><span class="composite ${sc}">${grade} ${scoreVal}</span></td>
    </tr>`;
  }).join('');
}

// Sorting
document.querySelectorAll('th[data-col]').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.col;
    if (sortCol === col) {
      sortDir *= -1;
    } else {
      sortCol = col;
      sortDir = col === 'name' ? 1 : -1;
    }
    document.querySelectorAll('th[data-col]').forEach(t => {
      t.classList.remove('sorted');
      t.removeAttribute('data-dir');
      t.querySelector('.sort-arrow').textContent = 'â†•';
    });
    th.classList.add('sorted');
    th.dataset.dir = sortDir === -1 ? 'â†“' : 'â†‘';
    th.querySelector('.sort-arrow').textContent = sortDir === -1 ? 'â†“' : 'â†‘';
    document.getElementById('sort-label').textContent = th.textContent.replace(/[â†•â†‘â†“]/g, '').trim();
    renderTable();
  });
});

// Filters
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const filterType = btn.dataset.filter;
    const value = btn.dataset.value;
    activeFilters[filterType] = value;
    // Update active state within group
    document.querySelectorAll(`.filter-btn[data-filter="${filterType}"]`).forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderTable();
  });
});

// Search
document.getElementById('search-input').addEventListener('input', e => {
  searchQuery = e.target.value;
  renderTable();
});

// Initial sort by score
document.querySelector('th[data-col="score"]').classList.add('sorted');
document.querySelector('th[data-col="score"]').dataset.dir = 'â†“';
document.querySelector('th[data-col="score"] .sort-arrow').textContent = 'â†“';
document.querySelector('th[data-col="rank"]').classList.remove('sorted');

renderTable();
</script>
</body>
</html>
